name: Create Conda Environment Package

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-activate-base: true
        activate-environment: ""
        
    - name: Create new Conda environment
      shell: bash -l {0}
      run: |
        conda create -n gpt python=3.11 -y
        conda activate gpt
        
    - name: Copy files (excluding .git)
      shell: bash -l {0}
      run: |
        mkdir temp_workspace
        cp -r * temp_workspace/ 2>/dev/null || :
        rm -rf temp_workspace/.git* || :
        
    - name: Install requirements
      shell: bash -l {0}
      run: |
        conda activate gpt
        pip install -r requirements.txt
        
    - name: Install conda-pack
      shell: bash -l {0}
      run: |
        conda activate gpt
        conda install conda-pack -y
        
    - name: Activate conda environment and pack conda
      shell: bash -l {0}
      run: |
        conda activate gpt
        mkdir -p temp_workspace
        conda pack -n gpt -o temp_workspace/gpt.tar.gz
      
    - name: Pack workspace
      shell: bash -l {0}
      run: |
        cd temp_workspace
        tar -czf workspace_with_env.tar.gz *
    
    - name: Upload packed files
      uses: actions/upload-artifact@v4
      with:
        name: gpt-academic-package
        path: temp_workspace/workspace_with_env.tar.gz
